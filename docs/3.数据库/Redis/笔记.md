# 1. 数据类型



* list里值的类型，set里值的类型，hash里键和值的类型，zset里值的类型，都是string,zset的score的类型是double

![](https://fanchaoo-notebook.oss-cn-beijing.aliyuncs.com/img/1754553-059e97e7fcfebab8.png)

![](https://fanchaoo-notebook.oss-cn-beijing.aliyuncs.com/img/1754553-4ee16e185eeedba5.png)




# 2. 持久化

Redis有两种持久化方式，一个是RDB，一个是AOF（Append Only File）。

## 2.1 RDB

### 概念

RDB是默认开启的持久化方式，它是将内存的数据快照，按照某种二进制的格式，直接序列化到硬盘上的一个dump.rdb文件里。

RDB和Hadoop的fsimage其实是类似的，都是通过内存快照来做持久化。

### 手动

可以直接通过save命令或者bgsave命令，来手动触发生成快照文件，。

save命令是一个同步的过程，在执行save命令的过程中，redis服务器不能对外提供服务。

basave是一个异步的过程，它会fork一个子进程，在子进程中执行持久化过程。

flushall也会生成一个空的快照文件。

### 自动

在redis中有一个每100毫秒执行一个的定时任务，在这个定时任务中有一段和自动持久化相关的代码。它会遍历配置文件里的配置信息（save 多少秒 多少次修改），依次判断看是否满足“上一次save操作到当前的修改次数是否大于配置中的修改次数”，如果满足，则执行bgsave操作。

因为RDB每次持久化之间是有一定的时间间隔的，所以如果在两次持久化操作之间Redis宕机了，则会导致这段时间间隔内的数据没有被持久化，会丢失一部分数据。


## 2.2 AOF

### 持久化

AOF是通过把所有写操作的命令，追加记录在一个文本文件里来做持久化的。

整个AOF的过程分为三步：写缓冲区，文件写入并同步。

Redis首先会把写命令写入本地的一个缓冲区里，接下来才会在某个时刻将缓冲区中的内容写入到文件。

写入文件的时机有两种：

* 每个循环执行一次：Redis整个运行过程是一个“循环”，在这个循环的末尾flushAppendOnlyFile的操作可以将缓冲区中的内容写入并同步到文件。
* 每秒执行一次：会有一个单独的线程负责执行每秒一次的写入并同步操作（这时候可能会丢失一秒数据）。
* 由操作系统负责同步：只是负责写入到文件，何时同步由操作系统决定。

AOF思想上可以和MySQL的binlog，Hadoop的edits文件类比下，都是在通过在日志文件里记录写操作来进行备份或者其它一些操作。

### 恢复

AOF恢复时，会创建一个不带网络连接的伪客户端，来逐一执行appendonly.aof里的命令，所以恢复起来会比RDB慢。

如果同时启动了RDB和AOF，在启动的时候，会优先加载AOF文件进行数据恢复。

### AOF重写

随着AOF文件的写入，文件会变得越来越庞大，这时候可以通过文件重写来创建一个新的AOF文件。

Redis会fork一个子进程，来读取内存中的键值对，然后将当前键值对的数据状态以命令的形式写入新的AOF文件。

在这个间隔期内，父进程会把新来的写命令在“AOF重写缓冲区”中记录下来。

最终父进程会把“AOF重写缓冲区”中的命令写入到新的AOF文件中，并重命名新文件去替换旧文件（这一步骤是阻塞的，不能接受客户端请求）。


# 3. 内存清除策略

有过期时间的key：LRU，随机，TTL最小的
所有key：LRU，随机
不清除，对写操作返回错误信息



# 4. 事务

可以通过multi命令来开启一个事务，接下来的多个命令都会依次存入一个队列里（不会真正执行），当执行exec命令的时候，才会依次真正执行队列中的命令。

事务中的命令，只要有一个命令有语法错误，则最终全部命令都会执行失败。

事务中的命令，如果有一个命令没有语法错误，但是在运行时报了错，则只有这条执行失败，其它命令依然会执行成功。

Redis还提供了一种类似乐观锁的watch机制，可以在开启事务前通过watch命令监控某些键，如果这些键的值在当前事务执行过程中被改变过，则当前事务全部指令执行失败。
同时也可以在事务中通过unwatch指令，取消对所有键的监控。



# 5. 集群



多master？

psync

复制偏移量，复制积压缓冲区

master下线

sentinel选举

master选举


分片




















